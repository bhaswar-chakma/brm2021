---
title: "Week 10"
date: "19 April 2021"
author: "Bhaswar Chakma"
output:
  html_document:
    code_folding: hide
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

#  {.tabset}

## Objectives

- Review `tidyr` functions

    - messy data sets

- `if_else()`

- `%in%`


## Tidy Data


```{r logo-tidyr, echo = FALSE, fig.align='center'}
knitr::include_graphics("images/tidy-data.png")
```

1. Each variable must have its own column.

2. Each observation must have its own row.

3. Each value must have its own cell.

Four functions:

1. `pivot_longer()`

2. `pivot_wider()`

3. `separate()`

4. `unite()`




## Messy Data{.tabset}

> “Happy families are all alike; every unhappy family is unhappy in its own way.” -- Leo Tolstoy

> “Tidy datasets are all alike, but every messy dataset is messy in its own way.” -- Hadley Wickham




**Data:**

- Create a folder `data` in your project directory. 

- [Click here to download](https://ucppt-my.sharepoint.com/:f:/g/personal/bhaswar_chakma_ucp_pt/EtziHFqAtc5BsmTvQ1nc9XIBP8d6H9_ns-vNPvMzCwjQ3g?e=C5Dwv4) or check in Teams/Files.

- Save them in the `data`folder.

### [**EXERCISE 1**]{style="color: blue;"}

- File: `w10-datastream.xlsx`

- Sheet: `research&dev`


```{r ugly1, echo = FALSE, fig.align='center'}
knitr::include_graphics("images/tidyr-ugly1.png")
```


- Do you need all the rows?

- Do you need all the columns?

- Variables needed:

   - `cname`: firms' names
   - `year`
   - `rnd`: Research and Development



```{r df-rnd, echo = FALSE}
library(readxl)
library(tidyverse)
df_rnd <- read_excel("data/w10-datastream.xlsx", 
                             sheet = "research&dev", skip = 3)
df_rnd_clean <- df_rnd %>%
  # drop unwanted variables
  select(-2, -3) %>%
  # reshape
  pivot_longer(
    cols = -1,
    names_to = "year",
    values_to = "rnd"
  ) %>% 
  # year as integer
  mutate(year = as.integer(year)) %>% 
  # Extract names
  separate(Name, into = c("cname", NA), sep = "-")

```


```{r echo = FALSE}
DT::datatable(df_rnd_clean)
```

```{r plot-rnd, echo = FALSE}
df_rnd_clean %>% 
  ggplot(aes(x = year, y = rnd/1e6, color = cname)) + # values are given in thousand
  geom_line() +
  geom_point()
```


### [**EXERCISE 2**]{style="color: blue;"}

- File: `w10-datastream.xlsx`

- Sheet: `employee-cash`


```{r ugly2, echo = FALSE, fig.align='center'}
knitr::include_graphics("images/tidyr-ugly2.png")
```


- Do you need all the rows?

- Do you need all the columns?

- Variables needed:

   - `cname`: firms' names
   - `year`
   - `employees`
   - `cash`
   
```{r df-ec, echo = FALSE}
df_ec <- read_excel("data/w10-datastream.xlsx", 
                     sheet = "employee-cash", skip = 3)
df_ec_clean <- df_ec %>% 
  select(-2, -3) %>% 
  pivot_longer(cols = -1,
               names_to = "year",
               values_to = "numbers") %>% 
  separate(Name, into = c("cname", "type"), sep = "-") %>% 
  pivot_wider(names_from = type,
              values_from = numbers) %>%
  rename(employees = 3,
         cash = 4) %>% 
  mutate(year = as.integer(year))


```

```{r echo = FALSE}
DT::datatable(df_ec_clean)
```


```{r emp-plot, echo = FALSE}
# employees
df_ec_clean %>%
  filter(year > 2014) %>% 
  ggplot(aes(x = year, y = employees/1000, fill  = cname)) +
  geom_col(position = "dodge")
```

## Useful Functions & Operators{.tabset}

We will use `gapminder::gapminder`

```{r}
library(gapminder)
gapminder
```

### [**%in%**]{style="color: blue;"}



Suppose we want to consider only these countries: France, Japan, and Australia

- Option 1: use `|`

```
gapminder %>% 
  filter(country == "France" | country == "Japan" | country == "Australia")
```

- Option 2: use `%in%`


```
gapminder %>% 
  filter(country %in% c("France", "Japan", "Australia"))
```

### [**if_else()**]{style="color: blue;"}

Suppose we want to create variable `portugal` (1 when country is Portugal; otherwise 0)

- We have been using `case_when()`

```
gapminder %>% 
  mutate(portugal = case_when(country == "Portugal" ~ 1,
                              country != "Portugal" ~ 0))
```
- We can use `if_else()`

    - Big picture;  `if_else(give_a_condition, value_when_true, value_when_false)`


```
gapminder %>% 
  mutate(portugal = if_else(country == "Portugal", 1, 0))
```

- another option

```
gapminder %>% 
  mutate(portugal = country == "Portugal") # logical
```


```
gapminder %>% 
  mutate(portugal = as.integer(country == "Portugal")) # TRUE becomes 1; FALSE becomes 0

```

### Dates

We will use the package `lubridate`
```{r}
library(lubridate)
```

- `ymd()`

```{r}
ymd("2021-12-01")
class(ymd("2021-12-01"))
```
- `ydm()`

```{r}
ydm("2021-01-12")
class(ymd("2021-01-12"))
```
- `dmy()`

```{r}
dmy("01-12-2021")
class(dmy("01-12-2021"))
```

**Extract Month**

```{r}
month(dmy("01-12-2021")) # month() is applied to a date object
month(dmy("01-12-2021"), label = TRUE) # get month names
```
**Extract Year**

```{r}
year(dmy("01-12-2021")) # year() is applied to a date object
```
**Extract Day**

```{r}
day(dmy("01-12-2021")) # date() is applied to a date object
```

## More Messy Data{.tabset}

- File: `Have_you_met_Ted_1_38_.xlsx`

  - The number 38 will change if we get more responses
  
Please fill out the [form.](https://forms.office.com/Pages/ResponsePage.aspx?id=GIvjszm6sUKsGjcltUihuh7wKeA4KWJDr7R5-P2dBuRURjFEMzlIWVQ4SzVRTFgzMlBJOTk2QkpIWC4u)

```{r}
df <- read_excel("data/Have you met _Ted__(1-38).xlsx")

df_renamed <- df %>% 
  select(6:15) %>% 
  rename(name = 1,
         id = 2,
         gender = 3,
         date_of_birth = 4,
         struggling = 5,
         reason_struggle = 6,
         practice_r = 7,
         social_media = 8,
         country = 9,
         himym = 10)
```


### [**Exercise 1**]{style="color: blue;"}

```{r}
table(df_renamed$country)
```
1. Fix the variable `country` using `case_when()` ; store it as `df_renamed2`

  - BRAZIL becomes Brazil
  - FRANCE becomes France

```{r, echo = FALSE}
df_renamed2 <- df_renamed %>% 
  mutate(country = case_when(country == "BRAZIL" ~ "Brazil",
                             country == "FRANCE" ~ "France",
                             country != "Brazil" | country != "France" ~ country))
```
  

```{r, echo = TRUE}
table(df_renamed$country)

table(df_renamed2$country)
```

2. Generate a dummy variable `international`: 1 if international student; otherwise 0

```{r, eval = FALSE}
df_renamed %>%
  mutate(international = if_else(country != "Portugal", 1, 0))
  
```



A better solution `str_to_title()`

```{r, eval = FALSE}
df_renamed %>% 
  mutate(country2 = str_to_title(country))
```

### [**Exercise 2**]{style="color: blue;"}

0. Select only `practice_r`; `social_media`; `gender`

1. What's wrong with 

  - `practice_r` ?
  
  - `social_media`?
  
2. Fix them; create two new variables `practice_r2` and `social_media2`

3. `practic_r2`: weekly averages

  - Update`practice_r2` finding daily averages (just divide by 7)

4. Store it as `df_time`


```{r, echo = FALSE}
df_time <- df_renamed %>%
  select(name, practice_r, social_media, gender) %>% 
  mutate(practice_r2 = if_else(practice_r == "3h", 180, as.numeric(practice_r)),
         social_media2 = if_else(social_media == "120min", 120, as.numeric(social_media)),
         practice_r2 = practice_r2/7) 
```

5. Produce the following plots



```{r, echo = FALSE}
df_time %>% 
  ggplot(aes(x = practice_r2, y = social_media2, color = gender)) +
  geom_point() 
```


```{r, echo = FALSE}
df_time %>% 
  ggplot(aes(x = gender, y = social_media2, fill = gender)) +
  geom_boxplot() 
```


### [**Exercise 3**]{style="color: blue;"}

Use `df_renamed`

0. Select `name` and `date_of_birth`

1. Can you find the oldest student?

```{r, echo = FALSE}
df_renamed %>% 
  select(name, date_of_birth) %>% 
  mutate(date_of_birth = ymd(date_of_birth)) %>% 
  arrange(date_of_birth)
```


2. Produce the following plot

```{r, echo = FALSE}
df_renamed %>% 
  select(name, date_of_birth) %>% 
  mutate(date_of_birth = ymd(date_of_birth),
         month = month(date_of_birth, label = TRUE)) %>% 
  ggplot(aes(x = month)) +
  geom_bar() +
  labs(title = "Birthdays")
```


[**Another R Hangout Session: Saturday 3.30pm (24 April 2021)**]{style="color: blue;"}
